# 2024/10/14网络技术之IPsecVPN学习笔记

1. 前置知识

   隧道技术，加解密技术，身份认证技术，数据认证技术，密钥管理技术

   1. 加解密结束，非对称加密与对称加密，非对称加密算法有ECC，RSA，RABIN等；对称加密算法有IDEA，DES/3DES算法等。

      |            | 对称加密   | 非对称加密 |
      | ---------- | ---------- | ---------- |
      | 加解密速度 | 快         | 较慢       |
      | 安全性     | 低         | 高         |
      | 密钥数量   | N取2的组合 | N          |

   2. 身份认证技术：解决文档传输的完整性真实性，通信双方的身份认证问题，抵赖性问题。
   
      发送者用自己的私钥，对原始信息的摘要做签名，生成数字签名，接收者使用发送者的公钥解开数字签名。接收者使用发送者的公钥加密摘要与身份信息，发送者使用私钥解密完成数据完整性校验。
   
   3. 数据认证技术：解决数据的传输安全
   
      ![image-20241014230139292](C:\Users\康国宁\AppData\Roaming\Typora\typora-user-images\image-20241014230139292.png)
   
      假设爱丽丝与鲍勃通信，爱丽丝发送信息给鲍勃
   
      1.原始信息经过hash算法生成信息摘要，信息摘要使用爱丽丝私钥加密生成数字签名；
   
      2.原始信息+数字签名+爱丽丝的公钥信息生成证书这三样东西被打包后使用对称加密算法生成加密信息，该加密信息的对称密钥使用非对称加密算法加密；并发送给鲍勃。
   
      3.鲍勃发送自己的CA证书给爱丽丝，该证书包含鲍勃的公钥，使用鲍勃的公钥加密对称加密算法的密钥，生成密钥信封发送给鲍勃，鲍勃收到密钥信封后用自己私钥解密，获得对称加密密钥；
   
      4.使用这个密钥解密发送的加密信息，获得爱丽丝的原始信息+数字签名+爱丽丝的公钥生成的证书，将该证书使用受信任的CA机构解密后，获得爱丽丝的公钥；
   
      5.使用爱丽丝公钥解开爱丽丝私钥签名的数字签名后，获得摘要信息，原始信息使用hash算法生成信息摘要，比较信息摘要是否相同。
   
      

2. IPsecVPN

   基于IPsec协议族构建的在IP层实现的安全虚拟专用网，通过在数据包中插入一个预定义的头部样式，来保证OSI上层协议的数据安全，主要用于保护TCP，UDP，ICMP，和隧道的IP数据包。

   |             | 两种工作模式        | 传输模式          |                  |
   | ----------- | ------------------- | ----------------- | ---------------- |
   |             |                     | 隧道模式          |                  |
   |             | 两个通信保护协议    | 鉴别头AH          |                  |
   |             |                     | 封装安全载荷ESP   |                  |
   | IPsec协议族 | 密钥交换管理协议IKE | 阶段一            | 主模式；野蛮模式 |
   |             |                     | 阶段二            |                  |
   |             | 解释域DOI           |                   |                  |
   |             | 两个数据库          | 安全策略数据库SPD |                  |
   |             |                     | 安全关联数据库SAD |                  |
   |             |                     |                   |                  |

   1. 隧道模式与传输模式的区别

      传输模式不改变原有包头，在原始包头后面加入一个IPsec头部，用于主机端到端通信，隧道模式改变原有包头，在原有包头前面加装一个IPsec包头，在IPsec包头加装新的IP包头。用于lan-lan的通信。

   2. 安全协议的区别

      AH协议认证完整IP数据包，且只提供认证服务，协议号为51

      ESP协议只保护被封装部分，只校验原始IP包头和IP数据部分，在隧道模式下，不校验新IP包头。

   3. 那种工作模式下，那个安全协议可以经过nat,原因

      1. 只有esp协议在隧道模式下可以经过nat
      2. 原因
         1. esp在隧道模式下不验证新的IP包头，可以在NAT模式下传输
         2. ESP在传输是下会验证最外面的原始IP包头，导致校验失败
         3. 而AH要提供数据来源确认，一旦源IP改变，AH校验失败

   4. IKE 协商

      1. 阶段一
         1. 建立一个已通过身份验证和安全保护的通道，建立了一个ISAKMP安全联盟，IKE SA，用来保护阶段二Ipsec SA的建立，第一阶段交换有两种协商模式：
            1. 主模式
               1. 默认使用自己的IP地址作为身份标识，默认是传递自己的接口地址做身份标识，校验对端的公网IP做对端身份标识(自动生成双方身份ID)。
            2. 野蛮模式
                  1. 可以使用用户名或者IP等作为双方的身份标识，也可手动配置身份ID。
                  2. 野蛮模式第一阶段交互过程
                     1. 第一个交互包发起方建议SA，发起DH，发送本端身份信息
                     2. 第二个交互包接受方接受SA，并向对方发送本端IKE策略信息，密钥材料，本端身份信息，同时生成对称密钥。
                     3. 第三个交互包发起方认证接收方
   
   5. 阶段二
   
      1. 在阶段一IKESA的保护下，为IPSEC协商具体的安全联盟，建立Ipsec SA，产生正真可以用来加密数据流的密钥，Ipsec SA用于最终的IP数据安全传送。
   
      2. 快速模式
   
         1. 交互包为三个，前两个包交换ipsec sa 的参数信息，并生成对称密钥，第二条消息还为响应方提供在场的证据，第三条消息为发起方提供在场的证据。
         2. 阶段二的三个包都在阶段一IKE SA的保护下进行。
   
      3. 密钥完美向前保密（PFS）
   
         1. 在IPSEC协商的第一阶段，通过DH算法进行了密钥的交互，并生成了加密密钥。如果不使用PFS，则第二阶段的加密密钥会根据第一阶段的密钥自动生成。使用了PFS，则第二阶段要重新通过IKE协商一个新的加密密钥，从而提高了数据的安全性。
   
      4. 隧道黑洞问题
   
         1. 对端的VPN连接已经断开，而我方还处于SA有效生存期时间内，从而形成VPN隧道黑洞问题，我方不停的发送加密后的VPN数据过去，但是对方拒绝接受。
   
         2. 如何解决
   
            需要启动DPD死亡对等体检测机制，检测对端的ISAKMP是否存在，当隧道异常时，能检测到并重新发起协商，来维持VPN隧道。
   
   6. 多VPN协商问题
   
      1. 协商问题
   
      IKE协商规定源和目的端口都必须为UDP 500，在多VPN场景下源端口可能会在防火墙设备NAT后发生变化，从而导致IKE协商失败。
   
      1. 传输问题
   
      数据传输过程中，由于ESP在工作在网络层，没有传输层头部，从而无法进行NAPT端口复用，导致数据传输失败
   
      1. 解决办法:
   
      启动nat-t功能
   
      (1)NAT-T协议运用在IPSecVPN中，在IKE协商和VPN连接时，允许源端口为非UDP 500端口，使用目的端口是UDP4500端口。I
   
      (2)NAT-T协议为ESP增加了UDP头部，从而解决了数据传输过程经过防火墙后无法进行端口复用的问题
   
       
   
      

​	

